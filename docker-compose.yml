version: '3.8'

services:
  # ============================================
  # MySQL Databases (one for each microservice)
  # ============================================
  
  mysql-user:
    image: mysql:8.0
    container_name: mysql-user
    restart: no
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: user_db
    ports:
      - "3307:3306"  # Map to 3307 on host to avoid conflicts
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql-tool:
    image: mysql:8.0
    container_name: mysql-tool
    restart: no
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: tool_db
    ports:
      - "3308:3306"  # Map to 3308 on host
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql-borrow:
    image: mysql:8.0
    container_name: mysql-borrow
    restart: no
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: borrow_db
    ports:
      - "3309:3306"  # Map to 3309 on host
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Eureka Server (Service Discovery)
  # ============================================
  
  eureka-server:
    build:
      context: ./eureka-server
      dockerfile: Dockerfile
    container_name: eureka-server
    restart: no
    ports:
      - "8761:8761"
    networks:
      - microservices-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health", "||", "exit", "1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ============================================
  # User Service
  # ============================================
  
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    restart: no
    ports:
      - "8081:8081"
    networks:
      - microservices-network
    depends_on:
      mysql-user:
        condition: service_healthy
      eureka-server:
        condition: service_started
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-user:3306/user_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/

  # ============================================
  # Tool Service
  # ============================================
  
  tool-service:
    build:
      context: ./tool-service
      dockerfile: Dockerfile
    container_name: tool-service
    restart: no
    ports:
      - "8082:8082"
    networks:
      - microservices-network
    depends_on:
      mysql-tool:
        condition: service_healthy
      eureka-server:
        condition: service_started
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-tool:3306/tool_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/

  # ============================================
  # Borrow Service (with Feign Clients)
  # ============================================
  
  borrow-service:
    build:
      context: ./borrow-service
      dockerfile: Dockerfile
    container_name: borrow-service
    restart: no
    ports:
      - "8083:8083"
    networks:
      - microservices-network
    depends_on:
      mysql-borrow:
        condition: service_healthy
      eureka-server:
        condition: service_started
      user-service:
        condition: service_started
      tool-service:
        condition: service_started
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-borrow:3306/borrow_db?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/

# ============================================
# Network Configuration
# ============================================

networks:
  microservices-network:
    driver: bridge
